
&НаСервере
&ИзменениеИКонтроль("ДобавитьВКорзинуНаКлиенте")
Функция Buro1Goz_ДобавитьВКорзинуНаКлиенте(ПараметрыТовара, НовыеСтроки)

	ПустаяКорзина = Объект.Корзина.Количество() = 0;
	РеквизитыОтбора = "Артикул, НоменклатураНабора, ХарактеристикаНабора, Номенклатура, Характеристика,
	|ХарактеристикиИспользуются, Упаковка, Цена, ВидЦены, Склад, ПроцентРучнойСкидки, ТипНоменклатуры,
	|СрокПоставки, ВариантОбеспечения, Обособленно, Серия";
	Если ИспользоватьДатыОтгрузки Тогда
		РеквизитыОтбора = РеквизитыОтбора + ", ДатаОтгрузки";
	КонецЕсли;
	Отбор = Новый Структура(РеквизитыОтбора);

	ИдентификаторыДляУстановкиСтатусаСерий = Новый Массив;
	ОбрабатываемыеСтроки = Новый Массив;
	ОбрабатываемыеСтрокиСПогрешностью = Новый Массив;
	ПогрешностьСтрок = Новый Соответствие();
	ОбрабатываемыеСтрокиСЦеной = Новый Массив;

	Для Каждого НоваяСтрока Из НовыеСтроки Цикл

		ЗаполнитьЗначенияСвойств(Отбор, НоваяСтрока);

		Если НоваяСтрока.Цена = 0 Тогда
			Отбор.ВидЦены = ПредопределенноеЗначение("Справочник.ВидыЦен.ПустаяСсылка");
		КонецЕсли;

		Если Не ЗначениеЗаполнено(Отбор.ТипНоменклатуры) Тогда
			Отбор.ТипНоменклатуры = ПараметрыТовара.ТипНоменклатуры;
		КонецЕсли;

		Если Не ЗначениеЗаполнено(Отбор.ВариантОбеспечения)
			И НЕ Отбор.ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Набор") Тогда
			ЗаполнитьВариантОбеспеченияИФлагНаСервере(Отбор);
		КонецЕсли;

		Если ПустаяКорзина Тогда
			РезультатПоиска = Новый Массив;
		Иначе
			РезультатПоиска = Объект.Корзина.НайтиСтроки(Отбор);
		КонецЕсли;

		ЦелевойМассив = ОбрабатываемыеСтроки;

		Если РезультатПоиска.Количество() = 0 Или НоваяСтрока.Погрешность <> 0 Тогда

			ТекущаяСтрока = Объект.Корзина.Добавить();
			ЗаполнитьЗначенияСвойств(ТекущаяСтрока, Отбор);
			ТекущаяСтрока.ИндексНабора = ?(ЗначениеЗаполнено(ТекущаяСтрока.НоменклатураНабора), 1, 0);

			ЦелевойМассив = ОбрабатываемыеСтрокиСПогрешностью;
			ПогрешностьСтрок.Вставить(ТекущаяСтрока, НоваяСтрока.Погрешность);

			Если Не ПараметрыТовара.ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Набор")
				И (РежимПодбораБезСуммовыхПараметров 
				Или Не ЗапрашиватьЦену
				Или ЦенообразованиеВызовСервера.НеобходимПересчетЦеныПриИзменении(ТекущаяСтрока.Номенклатура, "Серия", Неопределено)) Тогда

				ЦелевойМассив = ОбрабатываемыеСтрокиСЦеной;

			КонецЕсли;

		Иначе
			ТекущаяСтрока = РезультатПоиска[0];
		КонецЕсли;

		ТекущаяСтрока.КоличествоУпаковок = ТекущаяСтрока.КоличествоУпаковок + НоваяСтрока.КоличествоУпаковок;

		ЦелевойМассив.Добавить(ТекущаяСтрока);

		Если Не ПоказыватьПодобранныеТовары Тогда

			ТекстОповещения = Символы.ПС + НСтр("ru = 'Товар ""[Товар]"" стоимостью [Цена] [Валюта] в количестве [КоличествоУпаковок] [ЕдиницаИзмерения] добавлен в корзину'");

			ВставляемыеЗначения = Новый Структура("Товар, Цена, Валюта, КоличествоУпаковок, ЕдиницаИзмерения");

			ВставляемыеЗначения.Товар              = Строка(ТекущаяСтрока.Номенклатура) + ?(ЗначениеЗаполнено(НоваяСтрока.Характеристика)," (" + НоваяСтрока.Характеристика + ")","");
			ВставляемыеЗначения.Цена               = Формат(ТекущаяСтрока.Цена, "ЧДЦ=2; ЧН=");
			ВставляемыеЗначения.Валюта             = Валюта;
			ВставляемыеЗначения.ЕдиницаИзмерения   = ?(ЗначениеЗаполнено(НоваяСтрока.Упаковка), НоваяСтрока.Упаковка, НСтр("ru = 'ед.'"));
			ВставляемыеЗначения.КоличествоУпаковок = НоваяСтрока.КоличествоУпаковок;

			ТекстОповещения = СтроковыеФункцииКлиентСервер.ВставитьПараметрыВСтроку(ТекстОповещения, ВставляемыеЗначения);

		КонецЕсли;

		ТекущаяСтрока.ЗаказатьНаСклад = Истина;
		Если ЗначениеЗаполнено(ПараметрыУказанияСерий) Тогда
			Если Не ПроверитьУстановитьСтатусСерий(ТекущаяСтрока, ПараметрыУказанияСерий) Тогда
				ИдентификаторыДляУстановкиСтатусаСерий.Добавить(ТекущаяСтрока.ПолучитьИдентификатор());
			КонецЕсли;
		КонецЕсли;

	КонецЦикла;

	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	ДополнитьСтруктуруДействиямиПересчетаСумм(СтруктураДействий);

	СтруктураДействийСПогрешностью = ОбщегоНазначения.СкопироватьРекурсивно(СтруктураДействий, Ложь);
	СтруктураДействийСПогрешностью.Вставить("ПересчитатьСуммуСУчетомПогрешностиОкругления",
	Новый Структура("ПогрешностиПоСтрокам", ПогрешностьСтрок));

	СтруктураДействийСПогрешностью.Вставить("ЗаполнитьПризнакНаличияНоменклатурыПродаваемойСовместно",
	ВариантАнализаНоменклатурыПродаваемойСовместно);

	СтруктураДействийСЦеной = Новый Структура(); 
	Если ОбрабатываемыеСтрокиСЦеной.Количество() Тогда
		СтруктураДействийСЦеной = ОбщегоНазначения.СкопироватьРекурсивно(СтруктураДействийСПогрешностью, Ложь);
		ДополнитьСтруктуруДействиямиРасчетаЦены(ЭтотОбъект, СтруктураДействийСЦеной, ОбрабатываемыеСтрокиСЦеной[0]);
	КонецЕсли;

	ПакетнаяОбработкаТабличнойЧастиСервер.ОбработатьСтрокиТЧ(
	ОбрабатываемыеСтроки,
	СтруктураДействий,
	Объект.Корзина,
	Неопределено);

	ПакетнаяОбработкаТабличнойЧастиСервер.ОбработатьСтрокиТЧ(
	ОбрабатываемыеСтрокиСПогрешностью,
	СтруктураДействийСПогрешностью,
	Объект.Корзина,
	Неопределено);

	ПакетнаяОбработкаТабличнойЧастиСервер.ОбработатьСтрокиТЧ(
	ОбрабатываемыеСтрокиСЦеной,
	СтруктураДействийСЦеной,
	Объект.Корзина,
	Неопределено);

	Если ИдентификаторыДляУстановкиСтатусаСерий.Количество() > 0 Тогда
		ЗаполнитьСтатусыУказанияСерийПоИдентификатору(ИдентификаторыДляУстановкиСтатусаСерий);
	КонецЕсли;

	Если НовыеСтроки.Количество() > 0 Тогда
		Элементы.Корзина.ТекущаяСтрока = ТекущаяСтрока.ПолучитьИдентификатор();
	КонецЕсли;
	
	Возврат ТекстОповещения;

КонецФункции

&НаКлиенте
Процедура Buro1Goz_КорзинаНоменклатураПриИзмененииВместо(Элемент)
	
	ТекущаяСтрока = Элементы.Корзина.ТекущиеДанные;
	
	ТекущаяСтрока.Серия = Неопределено;
	ТекущаяСтрока.ВариантОбеспечения = Неопределено;
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверитьХарактеристикуПоВладельцу",    ТекущаяСтрока.Характеристика);
	СтруктураДействий.Вставить("ПроверитьЗаполнитьУпаковкуПоВладельцу", ТекущаяСтрока.Упаковка);
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры", Новый Структура("Номенклатура", "ТипНоменклатуры"));
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	
	ДополнитьСтруктуруДействиямиРасчетаЦены(ЭтотОбъект, СтруктураДействий, ТекущаяСтрока);
	
	ДополнитьСтруктуруДействиямиПересчетаСумм(СтруктураДействий);
	СтруктураДействий.Вставить("ЗаполнитьПризнакНаличияНоменклатурыПродаваемойСовместно", ВариантАнализаНоменклатурыПродаваемойСовместно);
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры", Новый Структура("Номенклатура", "ТипНоменклатуры"));
	
	ПакетнаяОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущаяСтрока, СтруктураДействий, КэшированныеЗначения);
	ЗаполнитьВариантОбеспеченияИФлагНаКлиенте(ТекущаяСтрока);
	
	ЗагрузитьСписокВыбораВариантовОбеспечения();
	
	Если ЗначениеЗаполнено(ПараметрыУказанияСерий) Тогда
		Если Не ПроверитьУстановитьСтатусСерий(ТекущаяСтрока, ПараметрыУказанияСерий) Тогда
			ЗаполнитьСтатусыУказанияСерийПоИдентификатору(ТекущаяСтрока.ПолучитьИдентификатор());
		КонецЕсли;
	КонецЕсли;
	
	ПодборТоваровКлиентСервер.УстановитьТекстИнформационнойНадписи(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура Buro1Goz_ПриОткрытииПосле(Отказ)
	
КонецПроцедуры

&НаКлиенте
&ИзменениеИКонтроль("ПодборТаблицаПриАктивизацииСтрокиОбработчикОжидания")
Процедура Buro1Goz_ПодборТаблицаПриАктивизацииСтрокиОбработчикОжиданияПосле()
	
	#Вставка
	// Обновляем остаток по организации в дереве
	Если ЗначениеЗаполнено(ТекущаяСтрокаНоменклатуры) Тогда
		Номенклатура = Неопределено;
		Характеристика = Неопределено;
		Если ТекущаяСтрокаНоменклатуры.Свойство("Номенклатура", Номенклатура) Тогда
			ТекущаяСтрокаНоменклатуры.Свойство("Характеристика", Характеристика);
			ОбновитьОстатокПоОрганизацииВДереве(Номенклатура, Характеристика, Организация);
		КонецЕсли;
	КонецЕсли;
	#КонецВставки
	
КонецПроцедуры

&НаКлиенте
&ИзменениеИКонтроль("ИерархияНоменклатурыПриАктивизацииСтрокиОбработчикОжидания")
Процедура Buro1Goz_ИерархияНоменклатурыПриАктивизацииСтрокиОбработчикОжиданияПосле()
	
	#Вставка
	// Обновляем остаток по организации в дереве
	Если ЗначениеЗаполнено(ТекущаяСтрокаНоменклатуры) Тогда
		Номенклатура = Неопределено;
		Характеристика = Неопределено;
		Если ТекущаяСтрокаНоменклатуры.Свойство("Номенклатура", Номенклатура) Тогда
			ТекущаяСтрокаНоменклатуры.Свойство("Характеристика", Характеристика);
			ОбновитьОстатокПоОрганизацииВДереве(Номенклатура, Характеристика, Организация);
		КонецЕсли;
	КонецЕсли;
	#КонецВставки
	
КонецПроцедуры

#Область ПолучениеОстатков

// Обновить остатки по организации в дереве товаров для подбора
//
// Параметры:
//  Номенклатура - СправочникСсылка.Номенклатура - Номенклатура
//  Характеристика - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристика
//  Организация - СправочникСсылка.Организации - Организация
//
&НаСервере
Процедура ОбновитьОстатокПоОрганизацииВДереве(Номенклатура, Характеристика, Организация)
	
	Если Не ЗначениеЗаполнено(Организация) Или Не ЗначениеЗаполнено(Номенклатура) Тогда
		Возврат;
	КонецЕсли;
	
	// Получаем остаток по организации для конкретной номенклатуры
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(ТоварыНаСкладахОстатки.КоличествоОстаток) КАК Остаток
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			,
	|			Организация = &Организация
	|				И Номенклатура = &Номенклатура
	|				И Характеристика = &Характеристика) КАК ТоварыНаСкладахОстатки";
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("Характеристика", Характеристика);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Остаток = 0;
	Иначе
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Остаток = Выборка.Остаток;
		Если Не ЗначениеЗаполнено(Остаток) Тогда
			Остаток = 0;
		КонецЕсли;
	КонецЕсли;
	
	// Заполняем все строки дерева ОстаткиТоваров
	Для Каждого СтрокаДерева Из ОстаткиТоваров.ПолучитьЭлементы() Цикл
		СтрокаДерева.ОстатокПоОрганизации = Остаток;
		СтрокаДерева.ОстатокПоОрганизацииОписание = Формат(Остаток, "ЧДЦ=3; ЧН=0,00; ЧГ=");
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти
